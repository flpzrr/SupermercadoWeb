<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8" />
    <title>Supermercado Online - Pedido</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet" />

    <style>
        body {
            background-color: #f8f9fa;
        }

        .container {
            margin-top: 50px;
            max-width: 700px;
        }

        .card {
            border-radius: 15px;
            box-shadow: 0px 3px 10px rgba(0,0,0,0.1);
        }

        footer {
            margin-top: 30px;
            text-align: center;
            color: #777;
        }

        .estoque-baixo {
            color: red;
            font-weight: bold;
        }

        .pix-box {
            background: #e6fff0;
            padding: 15px;
            border-radius: 8px;
            border: 1px dashed #28a745;
            margin-top: 10px;
        }

        .boleto-box {
            background: #fff7e6;
            padding: 15px;
            border-radius: 8px;
            border: 1px dashed #fd7e14;
            margin-top: 10px;
        }
    </style>
</head>
<body>

    <div class="container">
        <div class="card p-4">

            <h2 class="text-center mb-4">🛒 Monte seu Pedido</h2>

            <!-- PRODUTOS -->
            <div class="mb-3">
                <label class="form-label">Selecione o produto:</label>
                <select class="form-select" id="produto">
                    <option selected disabled>Carregando produtos...</option>
                </select>
                <small id="alertaEstoque" class="estoque-baixo"></small>
            </div>

            <!-- QUANTIDADE -->
            <div class="mb-3">
                <label class="form-label">Quantidade:</label>
                <input type="number" id="quantidade" class="form-control" min="1" value="1" />
            </div>

            <!-- CLIENTE -->
            <div class="mb-3">
                <label class="form-label">Nome do cliente:</label>
                <input type="text" id="nome" class="form-control" />
            </div>

            <div class="mb-3">
                <label class="form-label">Endereço de entrega:</label>
                <input type="text" id="endereco" class="form-control" />
            </div>

            <!-- PAGAMENTO -->
            <div class="mb-3">
                <label class="form-label">Forma de pagamento:</label>
                <select class="form-select" id="pagamento">
                    <option selected disabled>Carregando...</option>
                </select>
            </div>

            <!-- DADOS DO CARTÃO -->
            <div id="dadosCartao" style="display: none;">
                <h5 class="mt-3">💳 Dados do Cartão</h5>

                <div class="mb-2">
                    <label>Número do cartão</label>
                    <input type="text" class="form-control" id="numeroCartao" placeholder="0000 0000 0000 0000">
                </div>

                <div class="mb-2">
                    <label>Nome do titular</label>
                    <input type="text" class="form-control" id="nomeTitular">
                </div>

                <div class="row">
                    <div class="col-md-6">
                        <label>Validade</label>
                        <input type="text" class="form-control" id="validade" placeholder="MM/AA">
                    </div>

                    <div class="col-md-6">
                        <label>CVV</label>
                        <input type="text" class="form-control" id="cvv" placeholder="123">
                    </div>
                </div>
            </div>

            <!-- PIX -->
            <div id="pixArea" style="display: none;" class="pix-box mt-3">
                <h5>📱 PIX Copia e Cola:</h5>
                <p id="codigoPix" style="word-break: break-all; font-weight: bold;"></p>
            </div>

            <!-- BOLETO -->
            <div id="boletoArea" style="display: none;" class="boleto-box mt-3">
                <h5>🧾 Código de barras do Boleto:</h5>
                <p id="codigoBoleto" style="word-break: break-all; font-weight: bold;"></p>
            </div>

            <!-- TOTAL -->
            <div class="mb-3 mt-3">
                <label class="form-label">Valor total:</label>
                <input type="text" id="total" class="form-control" readonly />
            </div>

            <button class="btn btn-success w-100" id="btnFinalizar">Finalizar Pedido</button>

        </div>

        <footer>
            <p class="mt-4">
                <a href="dashboard.html">Área Administrativa</a>
            </p>
        </footer>
    </div>

    <script>
        let produtosBanco = [];

        async function carregarProdutos() {
            const select = document.getElementById("produto");

            try {
                const response = await fetch("http://localhost:5021/api/produto");
                produtosBanco = await response.json();

                select.innerHTML = '<option value="" disabled selected>Selecione um produto</option>';

                produtosBanco.forEach(p => {
                    const option = document.createElement("option");
                    option.value = p.id;
                    option.textContent = `${p.nome} - R$ ${p.preco.toFixed(2)} (Estoque: ${p.quantidade})`;
                    select.appendChild(option);
                });

            } catch (err) {
                select.innerHTML = '<option disabled>Erro ao carregar produtos</option>';
            }
        }

        async function carregarPagamentos() {
            const select = document.getElementById("pagamento");

            try {
                const response = await fetch("http://localhost:5021/api/FormaPagamento");
                const pagamentos = await response.json();

                select.innerHTML = '<option value="" disabled selected>Selecione</option>';

                pagamentos.forEach(p => {
                    const option = document.createElement("option");
                    option.value = p.nome;
                    option.textContent = p.nome;
                    select.appendChild(option);
                });

            } catch (err) {
                select.innerHTML = '<option disabled>Erro ao carregar pagamentos</option>';
            }
        }

        function calcularTotal() {
            const produtoId = parseInt(document.getElementById("produto").value);
            const quantidade = parseInt(document.getElementById("quantidade").value);

            const alerta = document.getElementById("alertaEstoque");
            alerta.textContent = "";

            if (!produtoId || !quantidade) return;

            const produto = produtosBanco.find(p => p.id === produtoId);

            if (produto) {
                if (produto.quantidade <= 5) {
                    alerta.textContent = `⚠️ Estoque baixo: ${produto.quantidade} unidades restantes`;
                }

                const total = produto.preco * quantidade;
                document.getElementById("total").value = "R$ " + total.toFixed(2);
            }
        }

        function gerarCodigoPix() {
            const codigo = 'PIX-' + Math.random().toString(36).substring(2, 30).toUpperCase();
            document.getElementById("codigoPix").innerText = codigo;
        }

        function gerarCodigoBoleto() {
            let codigo = "";
            for (let i = 0; i < 48; i++) {
                codigo += Math.floor(Math.random() * 10);
            }
            document.getElementById("codigoBoleto").innerText = codigo;
        }

        function verificarFormaPagamento() {
            const pagamento = document.getElementById("pagamento").value;

            const cartao = document.getElementById("dadosCartao");
            const pix = document.getElementById("pixArea");
            const boleto = document.getElementById("boletoArea");

            cartao.style.display = "none";
            pix.style.display = "none";
            boleto.style.display = "none";

            if (pagamento === "Cartão de Crédito") {
                cartao.style.display = "block";
            }

            if (pagamento === "Pix") {
                pix.style.display = "block";
                gerarCodigoPix();
            }

            if (pagamento === "Boleto") {
                boleto.style.display = "block";
                gerarCodigoBoleto();
            }
        }

        async function finalizarPedido() {
            const nome = document.getElementById("nome").value.trim();
            const endereco = document.getElementById("endereco").value.trim();
            const produtoId = parseInt(document.getElementById("produto").value);
            const quantidade = parseInt(document.getElementById("quantidade").value);

            if (!nome || !endereco || !produtoId || !quantidade) {
                alert("Preencha todos os campos.");
                return;
            }

            try {
                await fetch(`http://localhost:5021/api/produto/baixar?produtoId=${produtoId}&quantidade=${quantidade}`, {
                    method: "PUT"
                });

                alert("✅ Pedido Realizado Com Sucesso");

                document.getElementById("nome").value = "";
                document.getElementById("endereco").value = "";
                document.getElementById("quantidade").value = 1;
                document.getElementById("total").value = "";

                document.getElementById("dadosCartao").style.display = "none";
                document.getElementById("pixArea").style.display = "none";
                document.getElementById("boletoArea").style.display = "none";

                await carregarProdutos();

            } catch (err) {
                alert("Erro ao finalizar pedido");
            }
        }

        window.onload = () => {
            carregarProdutos();
            carregarPagamentos();

            document.getElementById("produto").addEventListener("change", calcularTotal);
            document.getElementById("quantidade").addEventListener("input", calcularTotal);
            document.getElementById("pagamento").addEventListener("change", verificarFormaPagamento);

            document.getElementById("btnFinalizar").addEventListener("click", finalizarPedido);
        };
    </script>

</body>
</html>
